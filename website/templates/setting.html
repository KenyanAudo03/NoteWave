<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Setting</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/setting.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_red.css"
    />

    <link
      rel="icon"
      href="{{ url_for('static', filename='img/notewave.ico') }}"
      type="image/x-icon"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  </head>
  <body>
    <main>
      <div class="messages-container">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {% if category == 'success' %}
          <i class="fas fa-check-circle"></i>
          {% else %}
          <i class="fas fa-times-circle"></i>
          {% endif %} {{ message }}
        </div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <div class="main-content">
        <nav class="navbar">
          <ul class="navbar-list">
            <li class="navbar-item">
              <button class="navbar-link active" data-nav-link>Account.</button>
            </li>

            <li class="navbar-item">
              <button class="navbar-link" data-nav-link>Notification.</button>
            </li>

            <li class="navbar-item">
              <button class="navbar-link" data-nav-link>Billing.</button>
            </li>

            <li class="navbar-item">
              <button class="navbar-link" data-nav-link>Privacy.</button>
            </li>

            <li class="navbar-item">
              <button class="navbar-link" data-nav-link>Data.</button>
            </li>
            {% if current_user.is_admin %}
            <li class="navbar-item">
              <button class="navbar-link" data-nav-link>Admin.</button>
            </li>
            {% endif %}
          </ul>
        </nav>

        <article class="about active" id="account.">
          <header>
            <h2 class="h2 article-title">
              Account
              <a href="/user_home" class="home-link">
                <i class="bx bx-home"></i>
              </a>
            </h2>
          </header>

          <section class="about-text" style="width: 100%">
            <h3>Personal Information <br /></h3>
            <small>Use a permanent address where you can receive mail.</small>
            <br />
            <div class="fields">
              <form
                id="profilePicForm"
                action="{{ url_for('auth.update_profile_pic') }}"
                method="POST"
                enctype="multipart/form-data"
                class="picture-form"
                style="display: none"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <input
                  type="file"
                  id="profilePic"
                  name="profile_pic"
                  accept="image/*"
                  class="file-input"
                />
                <input
                  type="hidden"
                  id="userId"
                  name="user_id"
                  value="{{ current_user.id }}"
                />
                <button
                  type="submit"
                  class="submit-button"
                  style="--background-color: {{ current_user.generated_color }}"
                >
                  Upload Pictures
                </button>
              </form>

              <figure class="avatar-box">
                {% if current_user.profile_picture %}
                <img
                  src="/static/profile_pics/{{ current_user.profile_picture }}"
                  alt="Profile Picture"
                  class="profile-image"
                  id="profileImage"
                />
                {% else %}
                <i
                  class="fas fa-5x"
                  style="--background-color: {{ current_user.generated_color }}"
                  >{{ current_user.first_name[0] }}</i
                >
                {% endif %}
              </figure>
              <div id="imageModal" class="modal" style="display: none">
                <img class="modal-content" id="modalImage" />
              </div>

              <div class="form-place">
                <p class="avatar-controls">
                  <button class="update-profile" id="editProfilePicButton">
                    Change avatar
                  </button>
                  <small>JPG, GIF, PNG, 5MB max</small>
                </p>
                <div id="croppingContainer" style="display: none">
                  <div class="cropbuttons">
                    <button
                      type="button"
                      id="cropButton"
                      class="crop-button"
                      style="--background-: {{ current_user.generated_color }}"
                    >
                      Upload
                    </button>
                    <button
                      type="button"
                      id="cancelButton"
                      class="cancel-button"
                      style="--background-: {{ current_user.generated_color }}"
                    >
                      Cancel
                    </button>
                  </div>
                  <div id="cropperWrapper">
                    <img id="imageToCrop" src="" alt="Image to crop" />
                    <div class="cropper-crop-box"></div>
                  </div>
                  <div id="progressContainer" style="display: none">
                    <div class="progress-circle">
                      <div class="progress-bar"></div>
                      <div class="progress-text">0%</div>
                    </div>
                  </div>
                </div>

                <div class="form">
                  <form
                    action="{{ url_for('auth.update_personal_info') }}"
                    method="POST"
                    id="personalInfoForm"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ csrf_token() }}"
                    />
                    <div class="names">
                      <div class="name-field">
                        <label for="firstName">First Name </label>
                        <input
                          type="text"
                          id="firstName"
                          name="firstName"
                          value="{{ current_user.first_name }}"
                          autocomplete="off"
                          required
                          maxlength="50"
                        />
                        <div
                          class="error-message"
                          id="firstNameError"
                          style="display: none; color: red"
                        ></div>
                      </div>
                      <div class="name-field">
                        <label for="secondName">Second Name </label>
                        <input
                          type="text"
                          id="secondName"
                          name="secondName"
                          autocomplete="off"
                          value="{{ current_user.second_name }}"
                          required
                          maxlength="50"
                        />
                        <div
                          class="error-message"
                          id="secondNameError"
                          style="display: none; color: red"
                        ></div>
                      </div>
                    </div>

                    <label for="generatedColor">Display Color</label>
                    <div style="display: flex; align-items: center">
                      <select name="generated_color" id="generatedColor">
                        <option value="{{ current_user.generated_color }}">
                          {{ current_user.generated_color }}
                        </option>
                        <option value="#FF0000">Red</option>
                        <option value="#00FF00">Green</option>
                        <option value="#0000ff">Blue</option>
                        <option value="#ffff00">Yellow</option>
                        <option value="#00ffff">Cyan</option>
                        <option value="#3498db">Sky Blue</option>
                        <option value="#2ecc71">Light Green</option>
                        <option value="#e67e22">Orange</option>
                        <option value="#95a5a6">Grey</option>
                        <option value="#9b59b6">Purple</option>
                      </select>
                      <div
                        id="colorPreview"
                        style="
                          width: 30px;
                          height: 30px;
                          margin-left: 10px;
                          border: 1px solid #ccc;
                        "
                      ></div>
                    </div>

                    <label for="dobInput">Date of Birth</label>
                    <input
                      type="text"
                      id="dobInput"
                      name="date_of_birth"
                      value="{{ current_user.date_birth }}"
                      placeholder="Select Date of Birth"
                    />

                    <label for="genderSelect">Gender</label>
                    <select id="genderSelect" name="gender">
                      <option value="">
                        {{ current_user.gender if current_user.gender else
                        'Select Gender' }}
                      </option>

                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    </select>

                    <button
                      type="submit"
                      class="submit"
                      id="submitBtn"
                      style="display: none"
                    >
                      Update Personal Information
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </section>

          <section class="testimonials">
            <h3>Account Information</h3>
            <form
              action="{{ url_for('auth.update_account_info') }}"
              method="POST"
              class="accountForm"
              id="accountForm"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />

              <label for="newEmail">Email</label>
              <input
                type="email"
                id="newEmail"
                name="newEmail"
                value="{{ current_user.email }}"
                autocomplete="off"
              />
              <div
                id="emailError"
                class="error-message"
                style="display: none"
              ></div>
              <button type="button" id="sendOtpBtn" style="display: none">
                Send Verification OTP
              </button>

              <label for="otpInput" style="display: none" id="otpLabel"
                >Enter OTP</label
              >
              <input
                type="text"
                id="otpInput"
                name="otp"
                style="display: none"
                placeholder="Enter the OTP sent to your email"
              />
              <div
                id="otpError"
                class="error-message"
                style="display: none"
              ></div>
              <div class="phone_numbers">
                <div class="name-field">
                  <button type="button" id="verifyOtpBtn" style="display: none">
                    Verify OTP
                  </button>
                </div>
                <div class="name-field">
                  <button type="button" id="resendOtpBtn" style="display: none">
                    Resend OTP
                  </button>
                </div>
              </div>

              <label for="newUsername">New Username</label>
              <input
                type="text"
                id="newUsername"
                name="newUsername"
                autocomplete="off"
                value="@{{ current_user.user_name[1:] }}"
                maxlength="16"
              />
              <div
                id="usernameError"
                class="error-message"
                style="display: none"
              ></div>

              <label for="bioInput">Bio</label>
              <textarea
                id="bioInput"
                name="bio"
                maxlength="60"
                autocomplete="off"
              >
{{ current_user.bio }}</textarea
              >

              <div id="bioCount" style="font-size: 12px">0/60</div>

              <button
                type="submit"
                class="submit"
                id="updateInfoBtn"
                style="display: none"
              >
                Update Account Information
              </button>
            </form>
          </section>

          <section class="testimonials">
            <h3>Contact Information</h3>
            <form
              action="{{ url_for('auth.update_contact_info') }}"
              method="POST"
              id="contactForm"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <div class="phone_numbers">
                <div class="name-field">
                  <label for="countryCode">Country Code</label>
                  <select id="countryCode" name="country_code">
                    <option value="">
                      {{ current_user.country_code if current_user.country_code
                      else 'Select Country Code' }}
                    </option>
                    <option value="+1">USA (+1)</option>
                    <option value="+254">Kenya (+254)</option>
                    <option value="+44">UK (+44)</option>
                    <option value="+61">Australia (+61)</option>
                    <option value="+49">Germany (+49)</option>
                    <option value="+33">France (+33)</option>
                    <option value="+39">Italy (+39)</option>
                    <option value="+81">Japan (+81)</option>
                    <option value="+86">China (+86)</option>
                    <option value="+91">India (+91)</option>
                    <option value="+55">Brazil (+55)</option>
                    <option value="+7">Russia (+7)</option>
                    <option value="+82">South Korea (+82)</option>
                    <option value="+34">Spain (+34)</option>
                    <option value="+32">Belgium (+32)</option>
                    <option value="+41">Switzerland (+41)</option>
                    <option value="+46">Sweden (+46)</option>
                    <option value="+45">Denmark (+45)</option>
                    <option value="+31">Netherlands (+31)</option>
                    <option value="+353">Ireland (+353)</option>
                    <option value="+351">Portugal (+351)</option>
                    <option value="+60">Malaysia (+60)</option>
                    <option value="+65">Singapore (+65)</option>
                    <option value="+66">Thailand (+66)</option>
                    <option value="+63">Philippines (+63)</option>
                    <option value="+64">New Zealand (+64)</option>
                    <option value="+20">Egypt (+20)</option>
                    <option value="+233">Ghana (+233)</option>
                  </select>
                </div>
                <div class="name-field">
                  <label for="phoneNumber">Phone Number</label>
                  <input
                    type="text"
                    id="phoneNumber"
                    name="phone_number"
                    placeholder="703853259"
                    value="{{ current_user.phone_number if current_user.phone_number else '' }}"
                    required
                    oninput="formatPhoneNumber(this)"
                  />

                  <small
                    id="error-message"
                    style="color: red; display: none"
                  ></small>
                </div>
              </div>
              <label for="timeZoneSearch">Timezone</label>
              <select id="timeZoneSearch" name="time_zone">
                <option value="">
                  {{ current_user.time_zone if current_user.time_zone else
                  'Select Timezone' }}
                </option>
                <option value="Europe/London">London</option>
                <option value="Europe/Paris">Paris</option>
                <option value="Asia/Tokyo">Tokyo</option>
                <option value="Africa/Nairobi">Nairobi</option>
                <option value="America/New_York">New York</option>
                <option value="America/Los_Angeles">Los Angeles</option>
                <option value="Europe/Berlin">Berlin</option>
                <option value="Europe/Rome">Rome</option>
                <option value="Asia/Shanghai">Shanghai</option>
                <option value="Asia/Kolkata">Kolkata</option>
                <option value="Australia/Sydney">Sydney</option>
                <option value="America/Sao_Paulo">São Paulo</option>
                <option value="Africa/Cairo">Cairo</option>
                <option value="Africa/Johannesburg">Johannesburg</option>
                <option value="Asia/Dubai">Dubai</option>
                <option value="America/Mexico_City">Mexico City</option>
                <option value="Europe/Moscow">Moscow</option>
                <option value="Asia/Singapore">Singapore</option>
                <option value="Europe/Zurich">Zurich</option>
                <option value="Asia/Hong_Kong">Hong Kong</option>
                <option value="Europe/Madrid">Madrid</option>
              </select>

              <button
                type="submit"
                class="submit"
                id="updateButton"
                style="display: none"
              >
                Update Contact Information
              </button>
            </form>
          </section>

          <section class="testimonials">
            <h3>Change Password</h3>
            <div
              id="notification"
              style="
                display: none;
                position: fixed;
                top: 10px;
                right: 10px;
                background-color: green;
                color: white;
                padding: 10px;
                border-radius: 5px;
                z-index: 1000;
              "
            >
              Password has been successfully changed!
            </div>
            <form
              id="passwordForm"
              action="{{ url_for('auth.update_password') }}"
              method="POST"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <label for="currentPassword">Current Password:</label>
              <div class="input-container">
                <input
                  type="password"
                  id="currentPassword"
                  name="currentPassword"
                  style="--background-: {{ current_user.generated_color }}"
                  required
                />
                <i
                  class="toggle-password fas fa-eye"
                  data-target="#currentPassword"
                ></i>
              </div>
              <div
                id="currentPasswordError"
                class="error-message"
                style="color: red"
              ></div>

              <label for="newPassword">New Password:</label>
              <div class="input-container">
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  autocomplete="off"
                  style="--background-: {{ current_user.generated_color }}"
                  required
                />
                <i
                  class="toggle-password fas fa-eye"
                  data-target="#newPassword"
                ></i>
              </div>
              <div
                id="newPasswordError"
                class="error-message"
                style="color: red"
              ></div>

              <label for="confirmPassword">Confirm New Password:</label>
              <div class="input-container">
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  style="--background-: {{ current_user.generated_color }}"
                  autocomplete="off"
                  required
                />
                <i
                  class="toggle-password fas fa-eye"
                  data-target="#confirmPassword"
                ></i>
              </div>
              <div
                id="confirmPasswordError"
                class="error-message"
                style="color: red"
              ></div>

              <div
                id="generalError"
                class="error-message"
                style="color: red; display: none"
              ></div>

              <button
                type="submit"
                style="--background-: {{ current_user.generated_color }}; display: none;"
                class="submit"
              >
                Update Password
              </button>
            </form>
          </section>

          <section class="about-text">
            <div class="log-out">
              <div class="title">
                <h3>Log Out</h3>
                <p>
                  Please enter your password to confirm you would like to log
                  out.
                </p>
              </div>
              <div class="form-log_out">
                <form
                  action="{{ url_for('auth.logout') }}"
                  method="POST"
                  id="checkSessions"
                >
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <label for="logOut">Your Password</label><br />
                  <input
                    type="password"
                    id="sessionLog"
                    name="password"
                    required
                  />
                  <div
                    id="sessionLogError"
                    class="error-message"
                    style="color: red; display: none"
                  ></div>

                  <button
                    type="submit"
                    style="--background: {{ current_user.generated_color }};"
                    class="submit"
                  >
                    Log out
                  </button>
                </form>
              </div>
            </div>
          </section>

          <section class="about-text">
            <div class="log-out">
              <div class="title">
                <h3>Deactivate Account</h3>
                <p>
                  Like want to deactivate your account? Instructions for
                  activation will be sent to your mail.
                </p>
              </div>
              <div class="form-log_out">
                <form
                  id="deactivateForm"
                  action="{{ url_for('auth.deactivate_account') }}"
                  method="POST"
                >
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <label for="logOut">Your Password</label><br />
                  <input type="password" id="logOut" name="password" required />
                  <div
                    id="passwordError"
                    class="error-message"
                    style="color: red; display: none"
                  ></div>
                  <button
                    type="submit"
                    style="--background-: {{ current_user.generated_color }}"
                    class="submit"
                  >
                    Deactivate account
                  </button>
                </form>
              </div>
            </div>
          </section>

          <section class="about-text last">
            <div class="log-out">
              <div class="title">
                <h3>Delete account</h3>

                <p>
                  No longer want to use our service? You can delete your account
                  here. This action is not reversible. All information related
                  to this account will be deleted permanently.
                </p>
              </div>
              <div class="form-log_out">
                <form
                  action="{{ url_for('auth.delete_account') }}"
                  method="post"
                  id="deleteForm"
                >
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <label for="logOut">Your Password</label><br />
                  <input type="password" id="delOut" required />
                  <div
                    id="deletepasswordError"
                    class="error-message"
                    style="color: red; display: none"
                  ></div>

                  <button
                    type="submit"
                    style="--background-: {{ current_user.generated_color }}"
                    class="submit"
                  >
                    Delete account
                  </button>
                </form>
              </div>
            </div>
          </section>
          <div id="loadingOverlay" style="display: none">
            <div class="spinner"></div>
            <p>Deleting Data...</p>
          </div>
        </article>

        <article class="portfolio" id="notification.">
          <header>
            <h2 class="h2 article-title">
              Notification
              <a href="/user_home" class="home-link">
                <i class="bx bx-home"></i>
              </a>
            </h2>
          </header>
          <section id="emailNotifications" class="notification-section">
            <h3 class="section-title">Email Notifications</h3>
            <form
              id="emailPreferencesForm"
              method="POST"
              action="{{ url_for('auth.update_email_preferences') }}"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <div class="form-group">
                <label for="activity_alerts">
                  <input
                    type="checkbox"
                    id="activity_alerts"
                    name="activity_alerts"
                    {%
                    if
                    current_user.email_preferences.activity_alerts
                    %}
                    checked
                    {%
                    endif
                    %}
                    onchange="this.form.submit();"
                  />
                  <span
                    class="toggle-switch"
                    style="margin-left: 8px; color: #fff"
                  ></span>
                  Receive Activity Alerts
                </label>
              </div>
            </form>
          </section>

          <section id="pushNotifications" class="notification-section">
            <h3 class="section-title">Push Notifications</h3>
            <form
              id="pushNotificationsForm"
              method="POST"
              action="{{ url_for('auth.update_push_notifications') }}"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <div class="form-group">
                <label for="new_message">
                  <input
                    type="checkbox"
                    id="new_message"
                    name="new_message"
                    {%
                    if
                    current_user.push_preferences.new_message
                    %}
                    checked
                    {%
                    endif
                    %}
                    onchange="this.form.submit();"
                  />
                  <span class="toggle-switch" style="margin-left: 8px"></span>
                  New Message Alerts
                </label>
              </div>
            </form>
          </section>

          <section class="account-activity-section">
            <h3 class="section-title">Recent Account Activity (Logins)</h3>
            <div class="table-container">
              <table class="activity-table">
                <thead>
                  <tr>
                    <th>Timestamp ({{current_user.time_zone}})</th>
                    <th>IP Address</th>
                    <th>User Agent</th>
                    <th>Browser</th>
                  </tr>
                </thead>
                <tbody>
                  {% for activity in current_user.login_activities %}
                  <tr>
                    <td>
                      {{ activity.get_local_timestamp().strftime('%Y-%m-%d
                      %H:%M:%S') }}
                    </td>
                    <td>{{ activity.ip_address }}</td>
                    <td class="user-agent">{{ activity.user_agent }}</td>
                    <td>{{ activity.browser_name }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
        </article>

        <article class="portfolio" id="billing.">
          <header>
            <h2 class="h2 article-title">
              Billing
              <a href="/user_home" class="home-link">
                <i class="bx bx-home"></i>
              </a>
            </h2>
          </header>

          <section id="currentPlan">
            <div class="card">
              <h3 class="section-title-card">Your Current Plan</h3>
              <p>
                {% if current_user.email_verified %} You are currently on the
                <strong>Test Plan</strong>. {% else %} You are currently on the
                <strong>Free Plan</strong>. Please verify your email to
                upgrade your plan. {% endif %}
              </p>

              {% if not current_user.email_verified %}
              <form
                action="{{ url_for('auth.resend_verification') }}"
                method="POST"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <div class="form-group-card">
                  <label for="email">Email address:</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    value="{{ current_user.email }}"
                    readonly
                    required
                    style="--background-color: {{ current_user.generated_color }}"
                  />
                </div>

                <button type="submit" class="btn">
                  Resend Verification Link
                </button>
              </form>
              {% endif %}
            </div>
          </section>
        </article>

        <article class="portfolio" id="privacy.">
          <header>
            <h2 class="h2 article-title">
              Privacy
              <a href="/user_home" class="home-link">
                <i class="bx bx-home"></i>
              </a>
            </h2>
          </header>

          <section id="privacySettings" class="settings-card">
            <div id="twoFactorAuthentication" class="setting-item">
              <h3 class="setting-title">Two-Factor Authentication (2FA)</h3>
              <div class="setting-content">
                {% if current_user.is_2fa_enabled %}
                <p>
                  Your Two-Factor Authentication is enabled using
                  <strong>{{ current_user.otp_method }}</strong>.
                </p>
                <form action="{{ url_for('auth.disable_2fa') }}" method="post">
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <button
                    type="submit"
                    id="disable2FAButton"
                    class="btn-action"
                    style="--background-color: {{ current_user.generated_color }}"
                  >
                    Disable 2FA
                  </button>
                </form>

                {% else %}
                <p>Your Two-Factor Authentication is not enabled.</p>

                <form
                  action="{{ url_for('auth.enable_2fa') }}"
                  method="post"
                  class="activeForm"
                  id="twoFac"
                >
                  <!-- CSRF Token to protect against CSRF attacks -->
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />

                  <div class="radio-group">
                    <label class="radio-label">
                      <input
                        type="checkbox"
                        name="otp_method"
                        value="app"
                        onclick="submit2FAForm(this)"
                      />
                      Use Authenticator App
                    </label>

                    <label class="radio-label">
                      <input
                        type="checkbox"
                        name="otp_method"
                        value="email"
                        onclick="submit2FAForm(this)"
                      />
                      Send OTP to Email
                    </label>
                  </div>
                </form>

                {% endif %}

                <div id="twoFAStatusMessage" class="status-message"></div>
              </div>
            </div>
            <div class="setting-item" class="setting-item">
              <h3 class="setting-title">Profile Visibility</h3>
              <form
                action="{{ url_for('auth.update_profile_visibility') }}"
                method="POST"
                class="activeForm"
                id="visibilityForm"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <label class="radio-label">
                  <input type="checkbox" name="profile_visibility"
                  value="public" {% if current_user.profile_visibility ==
                  "public" %} checked {% endif %} onclick="submitForm(this)">
                  Public
                </label>
                <label class="radio-label">
                  <input type="checkbox" name="profile_visibility"
                  value="connections" {% if current_user.profile_visibility ==
                  "connections" %} checked {% endif %}
                  onclick="submitForm(this)"> Connections Only
                </label>
                <label class="radio-label">
                  <input type="checkbox" name="profile_visibility"
                  value="private" {% if current_user.profile_visibility ==
                  "private" %} checked {% endif %} onclick="submitForm(this)">
                  Private
                </label>
              </form>
            </div>

            <div class="setting-item">
              <h3 class="setting-title">Encryption Password</h3>
              {% if current_user.encrypt_password %}

              <form
                id="resetEncryptPasswordForm"
                action="{{ url_for('auth.validate_reset_password') }}"
                method="POST"
              >
                <p>
                  Your encryption password is set. You can Change/Disable it
                  here:
                </p>
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <div>
                  <label for="reset_encrypt_password"
                    >Reset Encryption Password:</label
                  >

                  <div class="password-container">
                    <input
                      type="password"
                      name="reset_encrypt_password"
                      id="reset_encrypt_password"
                      required
                      autocomplete="off"
                      oninput="toggleEyeIcon(this, 'togglePasswordReset')"
                    />
                    <span
                      id="togglePasswordReset"
                      class="eye-icon-reset"
                      onclick="togglePasswordVisibility('reset_encrypt_password', 'togglePasswordReset')"
                      style="display: none; cursor: pointer"
                    >
                      👁️
                    </span>
                  </div>
                </div>
                <small id="reset-password-message" style="color: red"></small>
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <button type="submit" class="btn-action-encrypt">
                  Verify Password
                </button>
              </form>

              <div id="changePasswordSection" style="display: none">
                <h3>Change Password</h3>
                <form
                  action="{{ url_for('auth.change_encrypt_password') }}"
                  method="POST"
                  id="changeEncryptPasswordForm"
                >
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <div>
                    <label for="new_encrypt_password"
                      >New Encryption Password:</label
                    >
                    <div class="password-container">
                      <input
                        type="password"
                        name="new_encrypt_password"
                        id="new_encrypt_password"
                        required
                        autocomplete="off"
                        oninput="toggleEyeIcon(this, 'toggleNewPassword')"
                      />
                      <span
                        id="toggleNewPassword"
                        class="eye-icon"
                        onclick="togglePasswordVisibility('new_encrypt_password', 'toggleNewPassword')"
                        style="display: none; cursor: pointer"
                      >
                        👁️
                      </span>
                    </div>
                    <small
                      id="new-password-strength-message"
                      style="color: red"
                    ></small>
                  </div>

                  <div>
                    <label for="confirm_encrypt_password"
                      >Confirm Encryption Password:</label
                    >
                    <div class="password-container">
                      <input
                        type="password"
                        name="confirm_encrypt_password"
                        id="confirm_new_encrypt_password"
                        required
                        autocomplete="off"
                        oninput="toggleEyeIcon(this, 'toggleConfirmNewPassword')"
                      />
                      <span
                        id="toggleConfirmNewPassword"
                        class="eye-icon"
                        onclick="togglePasswordVisibility('confirm_new_encrypt_password', 'toggleConfirmNewPassword')"
                        style="display: none; cursor: pointer"
                      >
                        👁️
                      </span>
                    </div>
                    <small
                      id="new-confirm-password-message"
                      style="color: red"
                    ></small>
                  </div>

                  <button type="submit" class="btn-action-encrypt">
                    Change Encryption Password
                  </button>
                </form>

                <form
                  action="{{ url_for('auth.disable_encrypt_password') }}"
                  method="POST"
                  id="disableEncryptPasswordForm"
                >
                  <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                  />
                  <h3>Disable</h3>
                  <button type="submit" class="btn-action-encrypt">
                    Disable Encryption Password
                  </button>
                </form>
              </div>
              {% else %}

              <p>
                You do not have an encryption password set. Please set one
                below:
              </p>
              <form
                action="{{ url_for('auth.set_encrypt_password') }}"
                method="POST"
                id="setEncryptPasswordForm"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <div>
                  <label for="new_encrypt_password"
                    >Reset Encryption Password Key</label
                  >
                  <input
                    type="text"
                    name="new_encrypt_password"
                    id="new_encrypt_password"
                    required
                    autocomplete="off"
                  />
                </div>
                <div>
                  <label for="set_encrypt_password"
                    >Set Encryption Password</label
                  >
                  <div class="password-container">
                    <input
                      type="password"
                      name="set_encrypt_password"
                      id="set_encrypt_password"
                      required
                      autocomplete="off"
                      oninput="toggleEyeIcon(this, 'togglePasswordSet')"
                    />
                    <span
                      id="togglePasswordSet"
                      class="eye-icon"
                      onclick="togglePasswordVisibility('set_encrypt_password', 'togglePasswordSet')"
                      style="display: none; cursor: pointer"
                    >
                      👁️
                    </span>
                  </div>
                  <small
                    id="password-strength-message"
                    style="color: red"
                  ></small>
                </div>
                <div>
                  <label for="confirm_encrypt_password"
                    >Confirm Encryption Password</label
                  >
                  <div class="password-container">
                    <input
                      type="password"
                      name="confirm_encrypt_password"
                      id="confirm_encrypt_password"
                      required
                      autocomplete="off"
                      oninput="toggleEyeIcon(this, 'toggleConfirmPasswordSet')"
                    />
                    <span
                      id="toggleConfirmPasswordSet"
                      class="eye-icon"
                      onclick="togglePasswordVisibility('confirm_encrypt_password', 'toggleConfirmPasswordSet')"
                      style="display: none; cursor: pointer"
                    >
                      👁️
                    </span>
                  </div>
                  <small
                    id="confirm-password-message"
                    style="color: red"
                  ></small>
                </div>
                <button type="submit" class="btn-action-encrypt" id="submitBtn">
                  Set Encryption Password
                </button>
              </form>
              {% endif %}
            </div>
          </section>
        </article>

        {% if current_user.email_verified %}
        <article class="portfolio" id="data.">
          <header>
            <h2 class="h2 article-title">
              Data
              <a href="/user_home" class="home-link">
                <i class="bx bx-home"></i>
              </a>
            </h2>
          </header>

          <section id="privacySettings" class="notification-section">
            <h3 class="section-title">Export Your Notes</h3>

            <form
              action="{{ url_for('auth.export_notes') }}"
              method="GET"
              id="export-form"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <h3>Select Notes to Export:</h3>
              <ul class="export_ul">
                {% for note in current_user.notes %}
                <li class="export_li">
                  <label>
                    <input
                      type="checkbox"
                      name="note_ids"
                      value="{{ note.id }}"
                    />
                    <span>
                      {{ note.title[:20] }}{% if note.title|length > 20 %}...{%
                      endif %}
                    </span>
                  </label>
                </li>
                {% endfor %} {% if current_user.encrypt_password %}
                <li>
                  <label for="password">Enter Encryption Password:</label>
                  <input
                    type="password"
                    name="password"
                    class="export_password"
                    placeholder="Enter Encryption Password"
                    required
                    autocomplete="new-password"
                  />
                </li>
                {% endif %}
              </ul>

              <button type="submit" class="export_button">
                <i class="bx bx-note"></i>Export Selected Notes
              </button>

              <div class="tips">
                {% if current_user.encrypt_password %}
                <p>
                  <strong>Note:</strong> You have set an encryption password.
                  Please use it to export your notes securely. <br /><br />
                  <strong>Tip:</strong> The exported notes can only be used
                  within this application.
                </p>
                {% else %}
                <p>
                  <strong>Tip:</strong> Set an encryption password in the
                  Privacy tab to secure your exported notes. <br /><br />
                  <strong>Tip:</strong> The exported notes can only be used
                  within this application.
                </p>
                {% endif %}
              </div>
            </form>
          </section>

          <section id="privacySettings" class="notification-section">
            <h3 class="section-title">Export Your Details</h3>
            <ul class="export-details-list">
              <li>
                <a
                  href="{{ url_for('auth.export_user_details') }}"
                  class="export-link"
                >
                  <i class="bx bxs-user-detail"></i>
                  Export User Details
                </a>
              </li>
            </ul>
          </section>

          <section id="privacySettings" class="notification-section">
            <h3 class="section-title">Import Notes (File Format .json/.enc)</h3>

            <div class="drag-area">
              <div class="icon"><i class="fas fa-cloud-upload-alt"></i></div>
              <header>Drag & Drop to Upload File</header>
              <span>OR</span>
              <div class="button-area">
                <button type="button">Browse File</button>
              </div>
              <input
                type="file"
                name="file"
                id="file-input"
                accept=".json,.enc"
                hidden
                required
              />
            </div>
            <form
              id="import-form"
              action="{{ url_for('auth.import_notes') }}"
              method="POST"
              enctype="multipart/form-data"
              onsubmit="return validateForm()"
              style="display: none"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <input
                type="file"
                name="file"
                id="file-hidden"
                accept=".json,.enc"
                hidden
              />
              <div id="password-container" style="display: none">
                <label for="encryption_password"
                  >Enter Encryption Password:</label
                >
                <input
                  type="password"
                  name="encryption_password"
                  id="encryption-password"
                  autocomplete="off"
                  class="export_password"
                />
              </div>
              <button
                type="submit"
                class="import_button"
                style="--background-: {{ current_user.generated_color }}"
              >
                <i class="bx bx-note"></i>Import Data
              </button>
            </form>
          </section>
        </article>
        {% endif %}

        <article class="admin" id="admin.">
          <header>
            <h2 class="h2 article-title">
              Admin Dashboard
              <a href="/user_home" class="home-link">
                <i class="bx bx-home"></i>
              </a>
            </h2>
          </header>

          {% if current_user.role == 'superadmin' %}
          <section id="superAdminSection" class="superAdminSection">
            <h2>Platform Statistics</h2>
            <div class="chart-container">
              <canvas id="platformStatisticsChart"></canvas>
            </div>

            <h2>Monthly Statistics</h2>
            <div class="chart-container">
              <canvas id="monthlyStatisticsChart"></canvas>
            </div>

            <section id="loginActivities">
              <h2>Login Activities</h2>
              <div class="table-responsive">
                {% if login_activities %}
                <table>
                  <thead>
                    <tr>
                      <th>User ID</th>
                      <th>Email</th>
                      <th>Timestamp</th>
                      <th>IP Address</th>
                      <th>User Agent</th>
                      <th>Time Zone</th>
                      <th>Browser Name</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for activity in login_activities %}
                    <tr>
                      <td>{{ activity.user_id }}</td>
                      <td>{{ activity.email }}</td>
                      <td>
                        {{ activity.timestamp.strftime('%d/%m/%y %H:%M') }}
                      </td>
                      <td>{{ activity.ip_address }}</td>
                      <td>{{ activity.user_agent[:10] }}</td>
                      <td>{{ activity.time_zone }}</td>
                      <td>{{ activity.browser_name }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <p>No login activities found.</p>
                {% endif %}
              </div>
            </section>

            <section id="userNoteStatistics">
              <h2>User Note Statistics</h2>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>User ID</th>
                      <th>Username</th>
                      <th>Imported Notes Count</th>
                      <th>Exported Notes Count</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for note in note_counts %}
                    <tr>
                      <td>{{ note.user_id }}</td>
                      <td>{{ note.username }}</td>
                      <td>{{ note.imported_notes_count }}</td>
                      <td>{{ note.exported_notes_count }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </section>

            <section id="userStats">
              <h2>User Statistics</h2>
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>User ID</th>
                      <th>Full Name</th>
                      <th>Username</th>
                      <th>Total Notes</th>
                      <th>Total Todos</th>
                      <th>Total Note Tags</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user_data in statistics.users_data %}
                    <tr>
                      <td>{{ user_data.id }}</td>
                      <td>{{ user_data.full_name }}</td>
                      <td>{{ user_data.username }}</td>
                      <td>{{ user_data.total_notes }}</td>
                      <td>{{ user_data.total_todos }}</td>
                      <td>{{ user_data.note_tags }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </section>

            <h2>Manage Users</h2>
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Status</th>
                    <th>Actions</th>
                    <th>Make Admin</th>
                    <th>Delete User</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %}
                  <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>
                      {% if user.is_active %}
                      <i
                        class="fas fa-check-circle"
                        style="color: green"
                        title="Active"
                      ></i>
                      {% else %}
                      <i
                        class="fas fa-times-circle"
                        style="color: red"
                        title="Inactive"
                      ></i>
                      {% endif %}
                    </td>
                    <td>
                      {% if not user.is_active %}
                      <form
                        action="{{ url_for('auth.activate_account', user_id=user.id) }}"
                        method="post"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />
                        <button type="submit" class="activate_user">
                          Activate
                        </button>
                      </form>
                      {% else %} {% if user.role != 'superadmin' %}
                      <form
                        action="{{ url_for('auth.deactivate_user', user_id=user.id) }}"
                        method="post"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />
                        <button type="submit" class="activate_user">
                          Deactivate
                        </button>
                      </form>
                      {% else %}
                      <span>No action</span>
                      {% endif %} {% endif %}
                    </td>
                    <td>
                      {% if user.role == 'superadmin' %}
                      <span>No action</span>
                      {% elif not user.is_admin %}
                      <form
                        action="{{ url_for('auth.make_admin', user_id=user.id) }}"
                        method="post"
                        class="make-admin-form"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />

                        <button
                          type="button"
                          class="activate_user"
                          onclick="showRoleSelector(this)"
                        >
                          Make Admin
                        </button>

                        <div
                          class="role-selector"
                          style="display: none; margin-top: 10px"
                        >
                          <select
                            name="role"
                            required
                            class="form-control"
                            style="
                              margin-right: 5px;
                              display: inline-block;
                              width: auto;
                            "
                          >
                            <option value="admin">Admin</option>
                            <option value="user_activator">
                              User Activator
                            </option>
                            <option value="superadmin">Superadmin</option>
                          </select>
                          <button type="submit" class="btn btn-success">
                            Submit
                          </button>
                        </div>
                      </form>
                      {% else %}
                      <form
                        action="{{ url_for('auth.remove_admin', user_id=user.id) }}"
                        method="post"
                        style="display: inline"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />
                        <button
                          type="submit"
                          class="activate_user"
                          style="background-color: red"
                        >
                          Remove
                        </button>
                      </form>
                      {% endif %}
                    </td>

                    <td>
                      {% if user.role != 'superadmin' %}
                      <form
                        action="{{ url_for('auth.delete_user', user_id=user.id) }}"
                        method="post"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />
                        <button
                          type="submit"
                          class="activate_user"
                          style="background-color: red"
                        >
                          Delete
                        </button>
                      </form>
                      {% else %}
                      <span>No action</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
          {% endif %} {% if current_user.role == 'user_activator' %}
          <section id="userActivatorSection">
            <h2>Manage Users</h2>
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %} {% if user.role != 'superadmin' %}
                  <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                      {% if user.is_active %}
                      <i
                        class="fas fa-check-circle"
                        style="color: green"
                        title="Active"
                      ></i>
                      {% else %}
                      <i
                        class="fas fa-times-circle"
                        style="color: red"
                        title="Inactive"
                      ></i>
                      {% endif %}
                    </td>
                    <td>
                      {% if not user.is_active %}
                      <form
                        action="{{ url_for('auth.activate_account', user_id=user.id) }}"
                        method="post"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />
                        <button type="submit" class="activate_user">
                          Activate
                        </button>
                      </form>
                      {% else %} {% if user.role != 'admin' and user.id !=
                      current_user.id %}
                      <form
                        action="{{ url_for('auth.deactivate_user', user_id=user.id) }}"
                        method="post"
                      >
                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />
                        <button type="submit" class="activate_user">
                          Deactivate
                        </button>
                      </form>
                      {% else %}
                      <span>No action</span>
                      {% endif %} {% endif %}
                    </td>
                  </tr>
                  {% endif %} {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
          {% endif %}
        </article>
      </div>
    </main>

    <script>
      function submit2FAForm(checkbox) {
        const checkboxes = document.querySelectorAll(
          'input[name="otp_method"]'
        );
        checkboxes.forEach(function (box) {
          if (box !== checkbox) {
            box.checked = false;
          }
        });
        document.getElementById("twoFac").submit();
      }
    </script>
    <script src="{{ url_for('static', filename='js/setting.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      function showRoleSelector(button) {
        const roleSelector = button.nextElementSibling;
        if (
          roleSelector.style.display === "none" ||
          roleSelector.style.display === ""
        ) {
          roleSelector.style.display = "block";
        } else {
          roleSelector.style.display = "none";
        }
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        flatpickr("#dobInput", {
          altInput: true,
          altFormat: "F j, Y",
          dateFormat: "Y-m-d",
          maxDate: "today",
          theme: "material_red",
        });
      });
    </script>
    <script>
           const platformStatisticsCtx = document.getElementById('platformStatisticsChart').getContext('2d');
      const platformStatisticsChart = new Chart(platformStatisticsCtx, {
        type: 'bar',
        data: {
          labels: ['Total Users', 'Total Notes', 'Total Posts', 'Total Todos', 'Total Note Tags'],
          datasets: [{
            label: 'Counts',
            data: [
              {{ statistics.total_users }},
              {{ statistics.total_notes }},
              {{ statistics.total_posts }},
              {{ statistics.total_todos }},
              {{ statistics.note_tags }}
            ],
            backgroundColor: [
              'rgba(255, 99, 132, 0.2)',
              'rgba(54, 162, 235, 0.2)',
              'rgba(255, 206, 86, 0.2)',
              'rgba(75, 192, 192, 0.2)',
              'rgba(153, 102, 255, 0.2)',
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
            ],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Monthly Statistics Chart
      const monthlyStatisticsCtx = document.getElementById('monthlyStatisticsChart').getContext('2d');
      const monthlyStatisticsChart = new Chart(monthlyStatisticsCtx, {
        type: 'bar',
        data: {
          labels: ['New Users', 'New Notes', 'New ToDos'],
          datasets: [{
            label: 'Counts This Month',
            data: [
              {{ view_monthly_statistics.users_this_month }},
              {{ view_monthly_statistics.notes_this_month }},
              {{ view_monthly_statistics.todos_this_month }}
            ],
            backgroundColor: [
              'rgba(255, 159, 64, 0.2)',
              'rgba(255, 99, 132, 0.2)',
              'rgba(54, 162, 235, 0.2)',
            ],
            borderColor: [
              'rgba(255, 159, 64, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
            ],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const contactForm = document.getElementById("contactForm");
        const phoneNumberInput = document.getElementById("phoneNumber");
        const countryCodeSelect = document.getElementById("countryCode");
        const timeZoneSelect = document.getElementById("timeZoneSearch");
        const updateButton = document.getElementById("updateButton");
        const originalPhoneNumber = phoneNumberInput.value;
        const originalCountryCode = countryCodeSelect.value;
        const originalTimeZone = timeZoneSelect.value;
        function checkForChanges() {
          const currentPhoneNumber = phoneNumberInput.value;
          const currentCountryCode = countryCodeSelect.value;
          const currentTimeZone = timeZoneSelect.value;

          if (
            currentPhoneNumber !== originalPhoneNumber ||
            currentCountryCode !== originalCountryCode ||
            currentTimeZone !== originalTimeZone
          ) {
            updateButton.style.display = "block";
          } else {
            updateButton.style.display = "none";
          }
        }
        phoneNumberInput.addEventListener("input", checkForChanges);
        countryCodeSelect.addEventListener("change", checkForChanges);
        timeZoneSelect.addEventListener("change", checkForChanges);

        contactForm.addEventListener("submit", function (event) {
          event.preventDefault();

          const phoneInput = phoneNumberInput.value.replace(/\D/g, "");
          const errorMessageDiv = document.getElementById("error-message");
          errorMessageDiv.style.display = "none";
          let isValid = true;
          const minLength = 7;
          const maxLength = 15;

          if (phoneInput.length < minLength || phoneInput.length > maxLength) {
            errorMessageDiv.textContent = `Phone number must be between ${minLength} and ${maxLength} digits long (excluding country code).`;
            errorMessageDiv.style.display = "block";
            isValid = false;
          }

          if (isValid) {
            this.submit();
          } else {
            setTimeout(() => {
              errorMessageDiv.style.display = "none";
            }, 2000);
          }
        });
      });
    </script>

    <script>
      const dropArea = document.querySelector(".drag-area"),
        dragText = dropArea.querySelector("header"),
        button = dropArea.querySelector("button"),
        input = dropArea.querySelector("input[type='file']"),
        hiddenForm = document.getElementById("import-form"),
        fileHiddenInput = document.getElementById("file-hidden"),
        passwordContainer = document.getElementById("password-container"),
        passwordInput = document.getElementById("encryption-password");

      let file;

      button.onclick = () => {
        input.click();
      };
      input.addEventListener("change", function () {
        file = this.files[0];
        dropArea.classList.add("active");
        updateFileInput(file);
      });
      dropArea.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropArea.classList.add("active");
        dragText.textContent = "Release to Upload File";
      });
      dropArea.addEventListener("dragleave", () => {
        dropArea.classList.remove("active");
        dragText.textContent = "Drag & Drop to Upload File";
      });
      dropArea.addEventListener("drop", (event) => {
        event.preventDefault();
        file = event.dataTransfer.files[0];
        updateFileInput(file);
      });
      function updateFileInput(file) {
        let fileType = file.name.split(".").pop().toLowerCase();
        let validExtensions = ["json", "enc"];

        if (validExtensions.includes(fileType)) {
          dragText.textContent = `File Selected: ${file.name}`;
          hiddenForm.style.display = "block";
          fileHiddenInput.files = input.files;
          if (!input.files.length) {
            let dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileHiddenInput.files = dataTransfer.files;
          }
          if (fileType === "enc") {
            passwordContainer.style.display = "block";
            passwordInput.setAttribute("required", "required");
          } else {
            passwordContainer.style.display = "none";
            passwordInput.value = "";
            passwordInput.removeAttribute("required");
          }
        } else {
          alert("Invalid file type! Please upload a .json or .enc file.");
          dropArea.classList.remove("active");
          dragText.textContent = "Drag & Drop to Upload File";
        }
      }
      function validateForm() {
        if (
          passwordContainer.style.display === "block" &&
          !passwordInput.value
        ) {
          alert("Please enter the encryption password.");
          return false;
        }
        return true;
      }
    </script>

    <script>
      function isStrongPassword(password) {
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /[0-9]/.test(password);
        const hasSpecialChars = /[!@#$%^&*]/.test(password);

        return (
          password.length >= minLength &&
          hasUpperCase &&
          hasLowerCase &&
          (hasNumbers || hasSpecialChars)
        );
      }
      function showErrorMessage(messageElement, message) {
        messageElement.textContent = message;
        setTimeout(() => {
          messageElement.textContent = "";
        }, 2000);
      }

      document
        .getElementById("changeEncryptPasswordForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const newEncryptPassword = document.getElementById(
            "new_encrypt_password"
          ).value;
          const confirmEncryptPassword = document.getElementById(
            "confirm_new_encrypt_password"
          ).value;
          const strengthEncryptMessage = document.getElementById(
            "new-password-strength-message"
          );
          const confirmEncryptMessage = document.getElementById(
            "new-confirm-password-message"
          );
          let isValid = true;
          strengthEncryptMessage.textContent = "";
          confirmEncryptMessage.textContent = "";
          if (!isStrongPassword(newEncryptPassword)) {
            showErrorMessage(
              strengthEncryptMessage,
              "Password must be at least 8 characters long, include an uppercase letter, a lowercase letter, and either a number or a special character (or both)."
            );
            isValid = false;
          }
          if (newEncryptPassword !== confirmEncryptPassword) {
            showErrorMessage(confirmEncryptMessage, "Passwords do not match!");
            isValid = false;
          }
          if (isValid) {
            this.submit();
          }
        });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
          const alerts = document.querySelectorAll(".alert");
          alerts.forEach((alert, index) => {
            alert.classList.remove("show");
            alert.classList.add("fade");
            setTimeout(() => {
              alert.remove();
              if (index === alerts.length - 1) {
                const messagesContainer = document.querySelector(
                  ".messages-container"
                );
                if (messagesContainer) {
                  messagesContainer.remove();
                }
              }
            }, 150);
          });
        }, 3000);
      });
    </script>
    <script>
      function showErrorMessage(messageElement, message) {
        messageElement.textContent = message;
        setTimeout(() => {
          messageElement.textContent = "";
        }, 2000);
      }

      document
        .getElementById("resetEncryptPasswordForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const resetPassword = document.getElementById(
            "reset_encrypt_password"
          ).value;
          const resetMessage = document.getElementById(
            "reset-password-message"
          );
          const csrfToken = document.querySelector(
            'input[name="csrf_token"]'
          ).value;

          fetch("{{ url_for('auth.validate_reset_password') }}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken,
            },
            body: JSON.stringify({ reset_encrypt_password: resetPassword }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  "Network response was not ok " + response.statusText
                );
              }
              return response.json();
            })
            .then((data) => {
              if (data.valid) {
                document.getElementById(
                  "resetEncryptPasswordForm"
                ).style.display = "none";
                document.getElementById("changePasswordSection").style.display =
                  "block";
                resetMessage.textContent = "";
              } else {
                showErrorMessage(
                  resetMessage,
                  "Invalid reset encryption password."
                );
              }
            })
            .catch((error) => {
              console.error(
                "There was a problem with the fetch operation:",
                error
              );
              showErrorMessage(
                resetMessage,
                "An error occurred. Please try again."
              );
            });
        });
    </script>

    <script>
      function submitForm(checkbox) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function (box) {
          box.checked = false;
        });
        checkbox.checked = true;
        document.getElementById("visibilityForm").submit();
      }
    </script>

    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const navLinks = document.querySelectorAll("[data-nav-link]");
        const articles = document.querySelectorAll("article");
        articles.forEach((article, index) => {
          article.style.display = index === 0 ? "block" : "none";
        });

        navLinks.forEach((link) => {
          link.addEventListener("click", () => {
            navLinks.forEach((btn) => btn.classList.remove("active"));
            link.classList.add("active");
            const targetPage = link.textContent.trim().toLowerCase();
            articles.forEach((article) => (article.style.display = "none"));
            const targetArticle = document.getElementById(targetPage);
            if (targetArticle) {
              targetArticle.style.display = "block";
            }
          });
        });
      });
    </script>
  </body>
</html>
