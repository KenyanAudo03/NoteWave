@views.route("/todos")
@login_required
def show_todo_page():
    tags = NoteTag.query.filter_by(user_id=current_user.id).all()

    tag_counts = {}
    for tag in tags:
        note_count = Note.query.filter_by(
            tag_id=tag.id, user_id=current_user.id
        ).count()
        tag_counts[tag.id] = note_count

    todos = (
        ToDo.query.filter_by(user_id=current_user.id)
        .order_by(db.desc(ToDo.created_at))
        .all()
    )

    user_time_zone = current_user.time_zone if current_user.time_zone else "UTC"
    utc_now = datetime.utcnow().replace(tzinfo=pytz.utc)
    user_tz = pytz.timezone(user_time_zone)
    current_date = utc_now.astimezone(user_tz)

    for todo in todos:
        if todo.due_date:
            if todo.due_date.tzinfo is None:
                todo.due_date = pytz.utc.localize(todo.due_date)
            todo.due_date = todo.due_date.astimezone(user_tz)
            if todo.due_date < current_date and not todo.is_completed:
                todo.is_completed = True
                todo.updated_at = datetime.utcnow()
                db.session.commit()

    return render_template(
        "todos.html",
        todos=todos,
        tags=tags,
        tag_counts=tag_counts,
        current_date=current_date,
    )
